<tbody id="opportunitiesTableBody">
    <tr>
        <td colspan="9" class="loading">
            <div class="text-muted text-center py-4">
                <i class="fas fa-info-circle fa-2x mb-3 d-block"></i>
                <h6>No Analysis Results Yet</h6>
                <p class="mb-0">Upload your UK and Japan data files, then click "Run Analysis" to see profitable opportunities</p>
            </div>
        </td>
    </tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- Market Trends and Portfolio Optimizer Row -->
<div class="row mb-4">
<div class="col-md-8">
<div class="chart-container">
<h5 class="mb-3">
<i class="fas fa-chart-area me-2"></i>Market Trends Comparison
</h5>
<div class="chart-wrapper">
<canvas id="marketTrendsChart"></canvas>
</div>
</div>
</div>
<div class="col-md-4">
<div class="portfolio-section">
<h5 class="mb-3">
<i class="fas fa-briefcase me-2"></i>Portfolio Optimizer
</h5>
<div class="mb-3">
<label for="budgetInput" class="form-label">
<i class="fas fa-pound-sign me-2"></i>Investment Budget
</label>
<div class="input-group">
<span class="input-group-text">Â£</span>
<input type="number" class="form-control" id="budgetInput" value="100000" min="10000" max="1000000">
</div>
</div>
<button class="btn btn-primary w-100 mb-3" onclick="optimizePortfolio()">
<i class="fas fa-calculator me-2"></i>Optimize Portfolio
</button>

<div id="portfolioResults" style="display: none;">
<div class="border-top pt-3">
<h6><i class="fas fa-chart-pie me-2"></i>Optimization Results:</h6>
<div class="row text-center">
    <div class="col-6">
        <div class="border-end">
            <strong id="portfolioVehicles" class="text-primary">-</strong>
            <br><small class="text-muted">Vehicles</small>
        </div>
    </div>
    <div class="col-6">
        <strong id="portfolioROI" class="text-success">-</strong>
        <br><small class="text-muted">Expected ROI</small>
    </div>
</div>
<hr class="my-2">
<div class="row text-center">
    <div class="col-6">
        <div class="border-end">
            <strong id="portfolioProfit" class="text-warning">-</strong>
            <br><small class="text-muted">Total Profit</small>
        </div>
    </div>
    <div class="col-6">
        <strong id="portfolioBudgetUsed" class="text-info">-</strong>
        <br><small class="text-muted">Budget Used</small>
    </div>
</div>
</div>
</div>

<div class="mt-3 p-3 bg-light rounded">
<small class="text-muted">
<i class="fas fa-lightbulb me-2"></i>
<strong>Tip:</strong> The optimizer will suggest the best combination of vehicles within your budget for maximum profit and balanced risk.
</small>
</div>
</div>
</div>
</div>

<!-- Additional Info Section -->
<div class="row mb-4">
<div class="col-md-4">
<div class="metric-card">
<h6 class="text-muted mb-3">
<i class="fas fa-question-circle me-2"></i>How to Use
</h6>
<ol class="small text-muted mb-0">
<li>Download data templates above</li>
<li>Prepare your vehicle data in Excel/CSV</li>
<li>Upload UK market data</li>
<li>Upload Japan auction data</li>
<li>Click "Run Analysis" to find opportunities</li>
</ol>
</div>
</div>
<div class="col-md-4">
<div class="metric-card">
<h6 class="text-muted mb-3">
<i class="fas fa-file-alt me-2"></i>Data Format
</h6>
<div class="small text-muted">
<strong>UK Data:</strong> make, model, year, price, mileage, fuel_type<br>
<strong>Japan Data:</strong> make, model, year, final_price_jpy, grade, auction_house<br>
<em class="text-primary">Flexible column naming supported</em>
</div>
</div>
</div>
<div class="col-md-4">
<div class="metric-card">
<h6 class="text-muted mb-3">
<i class="fas fa-cogs me-2"></i>Features
</h6>
<ul class="small text-muted mb-0 list-unstyled">
<li><i class="fas fa-check text-success me-2"></i>Drag & Drop Upload</li>
<li><i class="fas fa-check text-success me-2"></i>Excel/CSV Support</li>
<li><i class="fas fa-check text-success me-2"></i>Profitability Analysis</li>
<li><i class="fas fa-check text-success me-2"></i>Portfolio Optimization</li>
<li><i class="fas fa-check text-success me-2"></i>Export Results</li>
</ul>
</div>
</div>
</div>

</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<!-- File Upload JavaScript -->
<script>
// Global variables for file upload state
let uploadState = {
ukData: false,
japanData: false,
analysisData: false
};

// Global variables for charts
let charts = {};
let currentData = {};

// Initialize file upload functionality
document.addEventListener('DOMContentLoaded', function() {
console.log('Initializing file upload dashboard...');

// Set up file input handlers
setupFileInputHandlers();

// Set up drag and drop
setupDragAndDrop();

// Load current data status
loadDataStatus();

// Load dashboard data if available
loadDashboardData();

// Initialize tooltips
initializeTooltips();
});

function initializeTooltips() {
// Initialize Bootstrap tooltips if needed
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
return new bootstrap.Tooltip(tooltipTriggerEl);
});
}

function setupFileInputHandlers() {
// UK file input
const ukFileInput = document.getElementById('ukFileInput');
if (ukFileInput) {
ukFileInput.addEventListener('change', function(e) {
handleFileSelect(e.target.files[0], 'uk');
});
}

// Japan file input
const japanFileInput = document.getElementById('japanFileInput');
if (japanFileInput) {
japanFileInput.addEventListener('change', function(e) {
handleFileSelect(e.target.files[0], 'japan');
});
}
}

function setupDragAndDrop() {
// UK drag and drop
const ukDragDrop = document.getElementById('ukDragDrop');
if (ukDragDrop) {
setupDragDropArea(ukDragDrop, 'uk');
}

// Japan drag and drop
const japanDragDrop = document.getElementById('japanDragDrop');
if (japanDragDrop) {
setupDragDropArea(japanDragDrop, 'japan');
}
}

function setupDragDropArea(element, dataType) {
element.addEventListener('dragover', function(e) {
e.preventDefault();
element.classList.add('dragover');
});

element.addEventListener('dragleave', function(e) {
e.preventDefault();
element.classList.remove('dragover');
});

element.addEventListener('drop', function(e) {
e.preventDefault();
element.classList.remove('dragover');

const files = e.dataTransfer.files;
if (files.length > 0) {
handleFileSelect(files[0], dataType);
}
});
}

function handleFileSelect(file, dataType) {
if (!file) return;

console.log(`File selected for ${dataType}:`, file.name);

// Validate file type
const allowedTypes = ['.csv', '.xlsx', '.xls'];
const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

if (!allowedTypes.includes(fileExtension)) {
showNotification(`Invalid file type. Please upload CSV, XLS, or XLSX files.`, 'error');
return;
}

// Validate file size (16MB max)
if (file.size > 16 * 1024 * 1024) {
showNotification(`File too large. Please upload files smaller than 16MB.`, 'error');
return;
}

// Show file info
const fileInfoElement = document.getElementById(`${dataType}FileInfo`);
if (fileInfoElement) {
fileInfoElement.innerHTML = `
<i class="fas fa-file me-2"></i>${file.name} 
<span class="text-muted">(${formatFileSize(file.size)})</span>
<span class="badge bg-success ms-2">Ready</span>
`;
fileInfoElement.style.display = 'block';
}

// Upload the file
uploadFile(file, dataType);
}

async function uploadFile(file, dataType) {
const endpoint = dataType === 'uk' ? '/api/upload-uk-data' : '/api/upload-japan-data';
const statusElement = document.getElementById(`${dataType}DataStatus`);
const progressElement = document.getElementById(`${dataType}Progress`);
const helpTextElement = document.getElementById(`${dataType}HelpText`);
const sectionElement = document.getElementById(`${dataType}UploadSection`);

try {
// Show uploading state
if (statusElement) {
statusElement.textContent = 'Uploading...';
statusElement.className = 'data-status status-uploading';
}
if (progressElement) progressElement.style.display = 'block';
if (sectionElement) sectionElement.classList.add('loading-pulse');

// Create form data
const formData = new FormData();
formData.append('file', file);

// Upload file
const response = await fetch(endpoint, {
method: 'POST',
body: formData
});

const result = await response.json();
console.log(`${dataType} upload result:`, result);

if (result.status === 'success') {
// Success
if (statusElement) {
statusElement.textContent = `${result.count} records`;
statusElement.className = 'data-status status-available';
}
if (helpTextElement) {
helpTextElement.innerHTML = `
<i class="fas fa-check-circle text-success me-2"></i>
Successfully uploaded ${result.count} ${dataType === 'uk' ? 'UK vehicles' : 'Japan auction vehicles'}
<br><small class="text-success">Source: ${result.source}</small>
`;
}
if (sectionElement) {
sectionElement.classList.add('upload-success');
setTimeout(() => sectionElement.classList.remove('upload-success'), 1000);
}

uploadState[`${dataType}Data`] = true;
showNotification(`${result.message}`, 'success');

// Check if analysis can be enabled
checkAnalysisReadiness();

} else {
// Error
if (statusElement) {
statusElement.textContent = 'Upload Failed';
statusElement.className = 'data-status status-empty';
}
if (helpTextElement) {
helpTextElement.innerHTML = `
<i class="fas fa-exclamation-triangle text-warning me-2"></i>
Upload failed: ${result.message}
<br><br>
<button class="template-btn" onclick="downloadTemplate('${dataType}')">
    <i class="fas fa-download me-2"></i>Download ${dataType.toUpperCase()} Template
</button>
`;
}
if (sectionElement) sectionElement.classList.add('upload-error');

showNotification(`${dataType.toUpperCase()} Upload Failed: ${result.message}`, 'error');
}

} catch (error) {
console.error(`${dataType} upload error:`, error);

if (statusElement) {
statusElement.textContent = 'Upload Failed';
statusElement.className = 'data-status status-empty';
}
if (helpTextElement) {
helpTextElement.innerHTML = `
<i class="fas fa-exclamation-triangle text-danger me-2"></i>
Upload failed: Network error
<br><br>
<button class="template-btn" onclick="downloadTemplate('${dataType}')">
<i class="fas fa-download me-2"></i>Download ${dataType.toUpperCase()} Template
</button>
`;
}
if (sectionElement) sectionElement.classList.add('upload-error');

showNotification(`${dataType.toUpperCase()} Upload Failed: ${error.message}`, 'error');

} finally {
// Hide progress and reset states
if (progressElement) progressElement.style.display = 'none';
if (sectionElement) {
sectionElement.classList.remove('loading-pulse');
setTimeout(() => {
sectionElement.classList.remove('upload-error');
}, 3000);
}
}
}

async function loadDataStatus() {
try {
console.log('Loading data status...');

const response = await fetch('/api/data-status');
if (response.ok) {
const data = await response.json();
console.log('Data status received:', data);
updateDataStatusDisplay(data);
}
} catch (error) {
console.error('Error loading data status:', error);
}
}

function updateDataStatusDisplay(data) {
// UK Data Status
const ukStatus = document.getElementById('ukDataStatus');
const ukHelpText = document.getElementById('ukHelpText');
if (ukStatus && ukHelpText) {
if (data.uk_data && data.uk_data.status === 'available') {
ukStatus.textContent = `${data.uk_data.count} records`;
ukStatus.className = 'data-status status-available';
ukHelpText.innerHTML = `
<i class="fas fa-check-circle text-success me-2"></i>
${data.uk_data.count} UK vehicles loaded
<br><small class="text-success">Last updated: ${new Date(data.uk_data.last_collection).toLocaleString()}</small>
`;
uploadState.ukData = true;
} else {
ukStatus.textContent = 'No Data';
ukStatus.className = 'data-status status-empty';
uploadState.ukData = false;
}
}

// Japan Data Status
const japanStatus = document.getElementById('japanDataStatus');
const japanHelpText = document.getElementById('japanHelpText');
if (japanStatus && japanHelpText) {
if (data.japan_data && data.japan_data.status === 'available') {
japanStatus.textContent = `${data.japan_data.count} records`;
japanStatus.className = 'data-status status-available';
japanHelpText.innerHTML = `
<i class="fas fa-check-circle text-success me-2"></i>
${data.japan_data.count} Japan auction vehicles loaded
<br><small class="text-success">Last updated: ${new Date(data.japan_data.last_collection).toLocaleString()}</small>
`;
uploadState.japanData = true;
} else {
japanStatus.textContent = 'No Data';
japanStatus.className = 'data-status status-empty';
uploadState.japanData = false;
}
}

// Analysis Status
const analysisStatus = document.getElementById('analysisStatus');
if (analysisStatus) {
if (data.analysis_data && data.analysis_data.status === 'available') {
analysisStatus.textContent = `${data.analysis_data.count} opportunities`;
analysisStatus.className = 'data-status status-available';
uploadState.analysisData = true;
} else {
analysisStatus.textContent = 'Ready';
analysisStatus.className = 'data-status status-empty';
uploadState.analysisData = false;
}
}

checkAnalysisReadiness();
}

function checkAnalysisReadiness() {
const runAnalysisBtn = document.getElementById('runAnalysisBtn');
const analysisHelpText = document.getElementById('analysisHelpText');
const analysisSection = document.getElementById('analysisSection');

if (runAnalysisBtn && analysisHelpText) {
if (uploadState.ukData && uploadState.japanData) {
runAnalysisBtn.disabled = false;
analysisHelpText.innerHTML = `
<i class="fas fa-check-circle text-success me-2"></i>
<span class="text-success">Ready to analyze!</span>
<br>Click above to find profitable opportunities
`;
if (analysisSection) analysisSection.classList.add('ready');
} else {
runAnalysisBtn.disabled = true;
const missing = [];
if (!uploadState.ukData) missing.push('UK data');
if (!uploadState.japanData) missing.push('Japan data');
analysisHelpText.innerHTML = `
<i class="fas fa-exclamation-triangle text-warning me-2"></i>
<span class="text-warning">Missing: ${missing.join(' and ')}</span>
<br>Upload both files to enable analysis
`;
if (analysisSection) analysisSection.classList.remove('ready');
}
}
}

async function runAnalysis() {
const btn = document.getElementById('runAnalysisBtn');
const progress = document.getElementById('analysisProgress');
const status = document.getElementById('analysisStatus');
const helpText = document.getElementById('analysisHelpText');
const analysisSection = document.getElementById('analysisSection');

try {
console.log('Starting analysis...');

// Show loading state
if (btn) btn.disabled = true;
if (progress) progress.style.display = 'block';
if (status) {
status.textContent = 'Analyzing...';
status.className = 'data-status status-uploading';
}
if (helpText) {
helpText.innerHTML = `
<i class="fas fa-cog fa-spin text-primary me-2"></i>
Running profitability analysis...
`;
}
if (analysisSection) analysisSection.classList.add('loading-pulse');

// Run analysis
const response = await fetch('/api/run-analysis', {
method: 'POST',
headers: { 'Content-Type': 'application/json' }
});

const result = await response.json();
console.log('Analysis result:', result);

if (result.status === 'success') {
// Success
if (status) {
status.textContent = `${result.count} opportunities`;
status.className = 'data-status status-available';
}
if (helpText) {
helpText.innerHTML = `
<i class="fas fa-check-circle text-success me-2"></i>
<span class="text-success">Analysis complete!</span>
<br>${result.count} profitable opportunities found
`;
}
uploadState.analysisData = true;

showNotification(`Analysis Complete: ${result.message}`, 'success');

// Refresh dashboard data
setTimeout(() => {
loadDashboardData();
}, 1000);

} else {
// Warning or no results
if (status) {
status.textContent = 'No Results';
status.className = 'data-status status-empty';
}
if (helpText) {
helpText.innerHTML = `
<i class="fas fa-exclamation-triangle text-warning me-2"></i>
${result.message}
`;
}

showNotification(`Analysis: ${result.message}`, 'warning');
}

} catch (error) {
console.error('Analysis error:', error);

if (status) {
status.textContent = 'Analysis Failed';
status.className = 'data-status status-empty';
}
if (helpText) {
helpText.innerHTML = `
<i class="fas fa-exclamation-triangle text-danger me-2"></i>
Analysis failed - please try again
`;
}

showNotification(`Analysis Failed: ${error.message}`, 'error');

} finally {
// Reset UI
if (progress) progress.style.display = 'none';
if (analysisSection) analysisSection.classList.remove('loading-pulse');
checkAnalysisReadiness();
}
}

function downloadTemplate(dataType) {
try {
const url = `/api/download-template/${dataType}`;
const link = document.createElement('a');
link.href = url;
link.download = `${dataType}_data_template.csv`;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);

showNotification(`Downloading ${dataType.toUpperCase()} template...`, 'info');
} catch (error) {
console.error('Error downloading template:', error);
showNotification('Download failed. Please try again.', 'error');
}
}

function formatFileSize(bytes) {
if (bytes === 0) return '0 Bytes';
const k = 1024;
const sizes = ['Bytes', 'KB', 'MB', 'GB'];
const i = Math.floor(Math.log(bytes) / Math.log(k));
return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showNotification(message, type = 'info') {
const notification = document.createElement('div');
notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
notification.style.cssText = `
position: fixed;
top: 80px;
right: 20px;
z-index: 9999;
max-width: 400px;
padding: 15px;
border-radius: 8px;
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
border: none;
`;

const icon = type === 'error' ? 'fa-exclamation-circle' : 
type === 'warning' ? 'fa-exclamation-triangle' : 
type === 'success' ? 'fa-check-circle' : 'fa-info-circle';

notification.innerHTML = `
<i class="fas ${icon} me-2"></i>
<strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}
<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
`;

document.body.appendChild(notification);

setTimeout(() => {
if (notification.parentElement) {
notification.remove();
}
}, 5000);
}

// Dashboard data loading and display functions
async function loadDashboardData() {
console.log('Loading dashboard data...');

try {
const promises = [
loadSummary(),
loadTopVehicles(),
loadMarketTrends()
];

await Promise.allSettled(promises);
showRefreshIndicator('Dashboard loaded successfully!');

} catch (error) {
console.error('Error loading dashboard data:', error);
}
}

async function loadSummary() {
try {
const response = await fetch('/api/summary');
if (!response.ok) throw new Error(`HTTP ${response.status}`);

const data = await response.json();
if (data.error) throw new Error(data.error);

currentData.summary = data;
updateSummaryMetrics(data);

} catch (error) {
console.error('Error loading summary:', error);
['totalOpportunities', 'avgProfitMargin', 'bestROI', 'totalProfit'].forEach(id => {
const element = document.getElementById(id);
if (element) {
element.textContent = '-';
}
});
}
}

function updateSummaryMetrics(data) {
try {
const analysis = data.market_summary?.analysis || {};

const totalOpps = analysis.vehicles_analyzed || data.database_stats?.analysis_results || 0;
document.getElementById('totalOpportunities').textContent = totalOpps;

const avgMargin = analysis.avg_profit_margin;
document.getElementById('avgProfitMargin').textContent = formatPercent(avgMargin);

const bestROI = analysis.max_profit_margin;
document.getElementById('bestROI').textContent = formatPercent(bestROI);

const totalProfit = analysis.total_profit_potential;
document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);

// Add animation to updated metrics
['totalOpportunities', 'avgProfitMargin', 'bestROI', 'totalProfit'].forEach(id => {
const element = document.getElementById(id);
if (element && element.textContent !== '-') {
element.closest('.metric-card').classList.add('upload-success');
setTimeout(() => {
element.closest('.metric-card').classList.remove('upload-success');
}, 1000);
}
});

} catch (error) {
console.error('Error updating summary metrics:', error);
}
}

async function loadTopVehicles() {
try {
const response = await fetch('/api/top-vehicles?limit=20');
if (!response.ok) throw new Error(`HTTP ${response.status}`);

const data = await response.json();
if (data.error) throw new Error(data.error);

currentData.topVehicles = data;
updateTopVehiclesTable(data.top_vehicles || []);
updateProfitabilityChart(data.top_vehicles || []);
updateRiskRewardChart(data.top_vehicles || []);

} catch (error) {
console.error('Error loading top vehicles:', error);
const tbody = document.getElementById('opportunitiesTableBody');
if (tbody) {
tbody.innerHTML = `
<tr>
<td colspan="9" class="text-center text-muted py-4">
    <i class="fas fa-exclamation-triangle fa-2x mb-3 d-block text-warning"></i>
    <h6>Error Loading Data</h6>
    <p class="mb-0">Please check your data files and try running the analysis again.</p>
</td>
</tr>
`;
}
}
}

function updateTopVehiclesTable(vehicles) {
const tbody = document.getElementById('opportunitiesTableBody');
if (!tbody) return;

if (!vehicles || vehicles.length === 0) {
tbody.innerHTML = `
<tr>
<td colspan="9" class="text-center text-muted py-4">
<i class="fas fa-info-circle fa-2x mb-3 d-block"></i>
<h6>No Analysis Results Yet</h6>
<p class="mb-0">Upload your UK and Japan data files, then click "Run Analysis" to see profitable opportunities</p>
</td>
</tr>
`;
return;
}

try {
tbody.innerHTML = vehicles.map(vehicle => {
const rank = vehicle.rank || 0;
const make = vehicle.make || 'Unknown';
const model = vehicle.model || 'Vehicle';
const year = vehicle.year || new Date().getFullYear();
const score = vehicle.final_score || 0;
const grade = vehicle.score_grade || 'C';
const margin = vehicle.profit_margin || 0;
const profit = vehicle.expected_profit || 0;
const roi = vehicle.roi || 0;
const riskLevel = vehicle.risk_level || 'Medium';
const category = vehicle.investment_category || 'Unknown';

return `
<tr class="table-row-hover">
<td>
    <span class="badge bg-primary fs-6">${rank}</span>
</td>
<td>
    <div class="d-flex align-items-center">
        <i class="fas fa-car text-muted me-2"></i>
        <div>
            <strong>${make} ${model}</strong><br>
            <small class="text-muted">${year}</small>
        </div>
    </div>
</td>
<td class="text-center">
    <span class="badge ${getScoreBadgeClass(score)} fs-6">${score.toFixed(1)}</span><br>
    <small class="text-muted">${grade}</small>
</td>
<td class="text-center">
    <strong class="text-success">${formatPercent(margin)}</strong>
</td>
<td class="text-center">
    <strong class="text-primary">${formatCurrency(profit)}</strong>
</td>
<td class="text-center">
    <span class="text-info">${formatPercent(roi)}</span>
</td>
<td class="text-center">
    <span class="status-badge ${getRiskBadgeClass(riskLevel)}">${riskLevel}</span>
</td>
<td>
    <small class="text-muted">${category}</small>
</td>
<td class="text-center">
    <button class="btn btn-sm btn-outline-primary" onclick="viewVehicleDetails('${make}', '${model}')" data-bs-toggle="tooltip" title="View detailed analysis">
        <i class="fas fa-eye"></i>
    </button>
</td>
</tr>
`;
}).join('');

// Reinitialize tooltips for new content
initializeTooltips();

} catch (error) {
console.error('Error updating vehicles table:', error);
tbody.innerHTML = `
<tr>
<td colspan="9" class="text-center text-danger py-4">
<i class="fas fa-exclamation-triangle fa-2x mb-3 d-block"></i>
<h6>Error Displaying Data</h6>
<p class="mb-0">There was an error processing the vehicle data.</p>
</td>
</tr>
`;
}
}

// Helper functions
function formatCurrency(value) {
if (typeof value !== 'number' || isNaN(value)) return 'Â£0';
return 'Â£' + Math.round(value).toLocaleString();
}

function formatPercent(value) {
if (typeof value !== 'number' || isNaN(value)) return '0%';
return (value * 100).toFixed(1) + '%';
}

function getScoreBadgeClass(score) {
if (score >= 85) return 'bg-success';
if (score >= 75) return 'bg-info';
if (score >= 65) return 'bg-warning';
return 'bg-secondary';
}

function getRiskBadgeClass(riskLevel) {
switch(riskLevel) {
case 'Very Low':
case 'Low': return 'status-excellent';
case 'Moderate': return 'status-good';
case 'High': return 'status-moderate';
default: return 'status-poor';
}
}

// Chart functions
function updateProfitabilityChart(vehicles) {
const ctx = document.getElementById('profitabilityChart');
if (!ctx || !vehicles || vehicles.length === 0) return;

try {
if (charts.profitability) {
charts.profitability.destroy();
}

const makeData = {};
vehicles.forEach(vehicle => {
const make = vehicle.make || 'Unknown';
const margin = vehicle.profit_margin || 0;

if (!makeData[make]) {
makeData[make] = { total: 0, count: 0 };
}
makeData[make].total += margin;
makeData[make].count += 1;
});

const makes = Object.keys(makeData);
const avgMargins = makes.map(make => (makeData[make].total / makeData[make].count) * 100);

const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
gradient.addColorStop(0, 'rgba(102, 126, 234, 0.8)');
gradient.addColorStop(1, 'rgba(102, 126, 234, 0.2)');

charts.profitability = new Chart(ctx, {
type: 'bar',
data: {
labels: makes,
datasets: [{
label: 'Average Profit Margin (%)',
data: avgMargins,
backgroundColor: gradient,
borderColor: 'rgba(102, 126, 234, 1)',
borderWidth: 2,
borderRadius: 6,
borderSkipped: false,
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
animation: {
duration: 1000,
easing: 'easeOutQuart'
},
plugins: {
legend: { 
    display: true, 
    position: 'top',
    labels: {
        usePointStyle: true,
        padding: 15
    }
},
tooltip: {
    backgroundColor: 'rgba(0,0,0,0.8)',
    titleColor: 'white',
    bodyColor: 'white',
    borderColor: 'rgba(102, 126, 234, 1)',
    borderWidth: 1,
    callbacks: {
        label: function(context) {
            return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
        }
    }
}
},
scales: {
x: { 
    display: true, 
    grid: { display: false },
    ticks: {
        color: '#6c757d'
    }
},
y: {
    beginAtZero: true,
    display: true,
    grid: { 
        color: 'rgba(0,0,0,0.1)',
        drawBorder: false
    },
    ticks: {
        color: '#6c757d',
        callback: function(value) {
            return value + '%';
        }
    }
}
}
}
});

} catch (error) {
console.error('Error updating profitability chart:', error);
}
}

function updateRiskRewardChart(vehicles) {
const ctx = document.getElementById('riskRewardChart');
if (!ctx || !vehicles || vehicles.length === 0) return;

try {
if (charts.riskReward) {
charts.riskReward.destroy();
}

const chartData = vehicles.map(v => ({
x: v.risk_score || Math.random() * 10,
y: (v.roi || 0) * 100,
label: `${v.make || 'Unknown'} ${v.model || 'Vehicle'}`,
score: v.final_score || 0
}));

charts.riskReward = new Chart(ctx, {
type: 'scatter',
data: {
datasets: [{
label: 'Vehicle Opportunities',
data: chartData,
backgroundColor: function(context) {
    const score = context.parsed.score || 50;
    if (score >= 85) return 'rgba(40, 167, 69, 0.7)';
    if (score >= 75) return 'rgba(102, 126, 234, 0.7)';
    if (score >= 65) return 'rgba(255, 193, 7, 0.7)';
    return 'rgba(108, 117, 125, 0.7)';
},
borderColor: function(context) {
    const score = context.parsed.score || 50;
    if (score >= 85) return 'rgba(40, 167, 69, 1)';
    if (score >= 75) return 'rgba(102, 126, 234, 1)';
    if (score >= 65) return 'rgba(255, 193, 7, 1)';
    return 'rgba(108, 117, 125, 1)';
},
pointRadius: 8,
pointHoverRadius: 12,
borderWidth: 2
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
animation: {
duration: 1000,
easing: 'easeOutQuart'
},
plugins: {
legend: { 
    display: true, 
    position: 'top',
    labels: {
        usePointStyle: true,
        padding: 15
    }
},
tooltip: {
    backgroundColor: 'rgba(0,0,0,0.8)',
    titleColor: 'white',
    bodyColor: 'white',
    borderColor: 'rgba(102, 126, 234, 1)',
    borderWidth: 1,
    callbacks: {
        label: function(context) {
            const point = context.raw;
            return [
                `Vehicle: ${point.label}`,
                `Risk Score: ${point.x.toFixed(1)}`,
                `ROI: ${point.y.toFixed(1)}%`
            ];
        }
    }
}
},
scales: {
x: {
    title: { 
        display: true, 
        text: 'Risk Score (Lower is Better)',
        color: '#6c757d'
    },
    beginAtZero: true,
    max: 10,
    grid: { 
        color: 'rgba(0,0,0,0.1)',
        drawBorder: false
    },
    ticks: {
        color: '#6c757d'
    }
},
y: {
    title: { 
        display: true, 
        text: 'Return on Investment (%)',
        color: '#6c757d'
    },
    beginAtZero: true,
    grid: { 
        color: 'rgba(0,0,0,0.1)',
        drawBorder: false
    },
    ticks: { 
        color: '#6c757d',
        callback: value => value + '%' 
    }
}
}
}
});

} catch (error) {
console.error('Error updating risk-reward chart:', error);
}
}

async function loadMarketTrends() {
try {
const response = await fetch('/api/market-trends');
if (!response.ok) throw new Error(`HTTP ${response.status}`);

const data = await response.json();
updateMarketTrendsChart(data);

} catch (error) {
console.error('Error loading market trends:', error);
updateMarketTrendsChart({});
}
}

function updateMarketTrendsChart(data) {
const ctx = document.getElementById('marketTrendsChart');
if (!ctx) return;

try {
if (charts.marketTrends) {
charts.marketTrends.destroy();
}

const ukData = data.uk_price_by_make || { x: [], y: [] };
const japanData = data.japan_price_by_make || { x: [], y: [] };

let allMakes = [...new Set([...(ukData.x || []), ...(japanData.x || [])])].sort();

if (allMakes.length === 0) {
allMakes = ['Toyota', 'Honda', 'Nissan', 'Mazda'];
ukData.x = allMakes;
ukData.y = [18500, 16200, 15800, 14500];
japanData.x = allMakes;
japanData.y = [12000, 10500, 9800, 8500];
}

const ctx2d = ctx.getContext('2d');
const ukGradient = ctx2d.createLinearGradient(0, 0, 0, 400);
ukGradient.addColorStop(0, 'rgba(102, 126, 234, 0.8)');
ukGradient.addColorStop(1, 'rgba(102, 126, 234, 0.2)');

const jpGradient = ctx2d.createLinearGradient(0, 0, 0, 400);
jpGradient.addColorStop(0, 'rgba(118, 75, 162, 0.8)');
jpGradient.addColorStop(1, 'rgba(118, 75, 162, 0.2)');

charts.marketTrends = new Chart(ctx, {
type: 'bar',
data: {
labels: allMakes,
datasets: [{
label: 'Average UK Price',
data: allMakes.map(make => {
    const index = ukData.x ? ukData.x.indexOf(make) : -1;
    return index >= 0 ? ukData.y[index] : 0;
}),
backgroundColor: ukGradient,
borderColor: 'rgba(102, 126, 234, 1)',
borderWidth: 2,
borderRadius: 6,
borderSkipped: false,
}, {
label: 'Average Japan Landed Cost',
data: allMakes.map(make => {
    const index = japanData.x ? japanData.x.indexOf(make) : -1;
    return index >= 0 ? japanData.y[index] : 0;
}),
backgroundColor: jpGradient,
borderColor: 'rgba(118, 75, 162, 1)',
borderWidth: 2,
borderRadius: 6,
borderSkipped: false,
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
animation: {
duration: 1000,
easing: 'easeOutQuart'
},
plugins: {
legend: { 
    display: true, 
    position: 'top',
    labels: {
        usePointStyle: true,
        padding: 15
    }
},
tooltip: {
    backgroundColor: 'rgba(0,0,0,0.8)',
    titleColor: 'white',
    bodyColor: 'white',
    borderColor: 'rgba(102, 126, 234, 1)',
    borderWidth: 1,
    callbacks: {
        label: function(context) {
            return `${context.dataset.label}: Â£${context.parsed.y.toLocaleString()}`;
        }
    }
}
},
scales: {
x: { 
    display: true, 
    grid: { display: false },
    ticks: {
        color: '#6c757d'
    }
},
y: {
    beginAtZero: false,
    display: true,
    grid: { 
        color: 'rgba(0,0,0,0.1)',
        drawBorder: false
    },
    ticks: {
        color: '#6c757d',
        callback: function(value) {
            return 'Â£' + value.toLocaleString();
        }
    }
}
}
}
});

} catch (error) {
console.error('Error updating market trends chart:', error);
}
}

// Export and portfolio functions
async function exportToExcel() {
try {
showNotification('Preparing export...', 'info');

const response = await fetch('/api/export/excel');
if (!response.ok) throw new Error(`Export failed: ${response.status}`);

const blob = await response.blob();
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `vehicle_analysis_${new Date().toISOString().split('T')[0]}.xlsx`;
document.body.appendChild(a);
a.click();
window.URL.revokeObjectURL(url);
document.body.removeChild(a);

showNotification('Export completed successfully!', 'success');

} catch (error) {
console.error('Error exporting data:', error);
showNotification('Export failed: ' + error.message, 'error');
}
}

async function optimizePortfolio() {
try {
const budgetInput = document.getElementById('budgetInput');
const budget = budgetInput ? budgetInput.value : 100000;

if (budget < 10000) {
showNotification('Please enter a budget of at least Â£10,000', 'warning');
return;
}

showNotification('Optimizing portfolio...', 'info');

const response = await fetch(`/api/portfolio-optimizer?budget=${budget}`);
if (!response.ok) throw new Error(`Optimization failed: ${response.status}`);

const data = await response.json();
if (data.error) throw new Error(data.error);

updatePortfolioResults(data);
showNotification('Portfolio optimization completed!', 'success');

} catch (error) {
console.error('Error optimizing portfolio:', error);
showNotification('Portfolio optimization failed: ' + error.message, 'error');
}
}

function updatePortfolioResults(data) {
try {
const elements = {
portfolioVehicles: data.number_of_vehicles || 0,
portfolioROI: formatPercent(data.portfolio_roi || 0),
portfolioProfit: formatCurrency(data.expected_total_profit || 0),
portfolioBudgetUsed: formatCurrency(data.allocated || 0)
};

Object.entries(elements).forEach(([id, value]) => {
const element = document.getElementById(id);
if (element) {
element.textContent = value;
// Add animation
element.classList.add('upload-success');
setTimeout(() => element.classList.remove('upload-success'), 1000);
}
});

const resultsDiv = document.getElementById('portfolioResults');
if (resultsDiv) {
resultsDiv.style.display = 'block';
resultsDiv.classList.add('upload-success');
setTimeout(() => resultsDiv.classList.remove('upload-success'), 1000);
}

} catch (error) {
console.error('Error updating portfolio results:', error);
}
}

async function searchVehicles() {
try {
const searchInput = document.getElementById('searchInput');
const query = searchInput ? searchInput.value.trim() : '';

if (!query) {
showNotification('Please enter a search term', 'warning');
return;
}

if (query.length < 2) {
showNotification('Please enter at least 2 characters', 'warning');
return;
}

const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=20`);
if (!response.ok) throw new Error(`Search failed: ${response.status}`);

const data = await response.json();
if (data.error) throw new Error(data.error);

const vehicles = data.results.map((result, index) => ({
rank: index + 1,
make: result.make,
model: result.model,
year: result.year,
final_score: result.final_score,
profit_margin: result.profit_margin,
expected_profit: result.expected_profit,
roi: result.roi || 0,
risk_level: 'Medium',
score_grade: 'B',
investment_category: 'Search Result'
}));

updateTopVehiclesTable(vehicles);
showNotification(`Found ${data.total_found} results for "${query}"`, 'success');

} catch (error) {
console.error('Error searching vehicles:', error);
showNotification('Search failed: ' + error.message, 'error');
}
}

function viewVehicleDetails(make, model) {
// Create a modal or detailed view
const modalContent = `
<div class="modal fade" id="vehicleDetailModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
    <h5 class="modal-title">
        <i class="fas fa-car me-2"></i>${make} ${model} - Detailed Analysis
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
    <div class="row">
        <div class="col-md-6">
            <h6><i class="fas fa-flag me-2"></i>UK Market Data</h6>
            <p class="text-muted">Detailed UK market analysis would be shown here...</p>
        </div>
        <div class="col-md-6">
            <h6><i class="fas fa-torii-gate me-2"></i>Japan Auction Data</h6>
            <p class="text-muted">Detailed Japan auction analysis would be shown here...</p>
        </div>
    </div>
    <hr>
    <h6><i class="fas fa-chart-line me-2"></i>Profitability Analysis</h6>
    <p class="text-muted">Comprehensive profitability breakdown would be displayed here...</p>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
    <button type="button" class="btn btn-primary">Add to Portfolio</button>
</div>
</div>
</div>
</div>
`;

// Remove existing modal if any
const existingModal = document.getElementById('vehicleDetailModal');
if (existingModal) {
existingModal.remove();
}

// Add modal to body
document.body.insertAdjacentHTML('beforeend', modalContent);

// Show modal
const modal = new bootstrap.Modal(document.getElementById('vehicleDetailModal'));
modal.show();

// Clean up modal after it's hidden
document.getElementById('vehicleDetailModal').addEventListener('hidden.bs.modal', function() {
this.remove();
});
}

function showRefreshIndicator(message = 'Data updated successfully!') {
const indicator = document.getElementById('refreshIndicator');
if (indicator) {
indicator.innerHTML = `<i class="fas fa-check-circle me-2"></i>${message}`;
indicator.style.display = 'block';

setTimeout(() => {
indicator.style.display = 'none';
}, 3000);
}
}

// Handle search on Enter key
document.addEventListener('keypress', function(e) {
if (e.target.id === 'searchInput' && e.key === 'Enter') {
e.preventDefault();
searchVehicles();
}
});

// Handle budget input formatting
document.addEventListener('input', function(e) {
if (e.target.id === 'budgetInput') {
const value = parseInt(e.target.value);
if (value < 10000) {
e.target.setCustomValidity('Minimum budget is Â£10,000');
} else if (value > 1000000) {
e.target.setCustomValidity('Maximum budget is Â£1,000,000');
} else {
e.target.setCustomValidity('');
}
}
});

// Error handling for uncaught errors
window.addEventListener('error', function(event) {
console.error('Uncaught error:', event.error);
showNotification('An unexpected error occurred. Please refresh the page and try again.', 'error');
});

window.addEventListener('unhandledrejection', function(event) {
console.error('Unhandled promise rejection:', event.reason);
showNotification('Network error occurred. Please check your connection and try again.', 'error');
});

// Add some loading animation when page loads
window.addEventListener('load', function() {
// Remove any loading classes
document.body.classList.remove('loading');

// Add a subtle animation to metric cards
const metricCards = document.querySelectorAll('.metric-card');
metricCards.forEach((card, index) => {
setTimeout(() => {
card.style.opacity = '0';
card.style.transform = 'translateY(20px)';
card.style.transition = 'all 0.3s ease';

setTimeout(() => {
card.style.opacity = '1';
card.style.transform = 'translateY(0)';
}, 100);
}, index * 100);
});
});

console.log('Complete file upload dashboard loaded successfully!');
</script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vehicle Import Analyzer - Dashboard</title>

<!-- Bootstrap CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<!-- Custom CSS -->
<style>
.dashboard-header {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
padding: 2rem 0;
margin-bottom: 2rem;
}

.metric-card {
background: white;
border-radius: 12px;
padding: 1.5rem;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
border-left: 4px solid #667eea;
height: 100%;
transition: transform 0.2s ease;
}

.metric-card:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.metric-value {
font-size: 2rem;
font-weight: bold;
color: #667eea;
}

.metric-label {
color: #6c757d;
font-size: 0.9rem;
text-transform: uppercase;
letter-spacing: 0.5px;
}

/* File Upload Panel Styles */
.file-upload-panel {
background: white;
border-radius: 12px;
padding: 2rem;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
margin-bottom: 2rem;
border: 2px solid #e9ecef;
}

.file-upload-panel h3 {
color: #667eea;
margin-bottom: 1.5rem;
border-bottom: 2px solid #f8f9fa;
padding-bottom: 0.5rem;
display: flex;
align-items: center;
gap: 0.5rem;
}

.upload-section {
background: #f8f9fa;
border: 2px dashed #dee2e6;
border-radius: 8px;
padding: 2rem;
margin-bottom: 1rem;
transition: all 0.3s ease;
text-align: center;
min-height: 350px;
display: flex;
flex-direction: column;
justify-content: center;
}

.upload-section:hover {
border-color: #667eea;
background: #f0f3ff;
transform: translateY(-2px);
}

.upload-section.dragover {
border-color: #667eea;
background: #e6f2ff;
transform: scale(1.02);
box-shadow: 0 8px 16px rgba(102, 126, 234, 0.2);
}

.upload-section h5 {
color: #495057;
margin-bottom: 1rem;
display: flex;
align-items: center;
justify-content: center;
gap: 0.5rem;
}

.data-status {
display: inline-block;
padding: 0.4rem 1rem;
border-radius: 25px;
font-size: 0.85rem;
font-weight: 600;
margin-bottom: 1rem;
min-width: 120px;
}

.status-empty { 
background-color: #f8d7da; 
color: #721c24; 
border: 1px solid #f5c6cb;
}
.status-available { 
background-color: #d4edda; 
color: #155724; 
border: 1px solid #c3e6cb;
}
.status-uploading { 
background-color: #fff3cd; 
color: #856404; 
border: 1px solid #ffeaa7;
}

.upload-btn {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
border: none;
padding: 0.75rem 1.5rem;
border-radius: 8px;
color: white;
font-weight: 500;
transition: all 0.3s ease;
margin: 0.25rem;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.upload-btn:hover {
background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
transform: translateY(-2px);
box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.upload-btn:disabled {
background: #6c757d;
transform: none;
cursor: not-allowed;
}

.japan-btn {
background: linear-gradient(135deg, #e83e8c 0%, #fd7e14 100%);
}

.japan-btn:hover {
background: linear-gradient(135deg, #d73384 0%, #e8660c 100%);
}

.analysis-btn {
background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.analysis-btn:hover {
background: linear-gradient(135deg, #218838 0%, #1abc9c 100%);
}

.template-btn {
background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
color: white;
border: none;
padding: 0.5rem 1rem;
border-radius: 6px;
font-size: 0.875rem;
margin: 0.25rem;
transition: all 0.2s ease;
}

.template-btn:hover {
background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
transform: translateY(-1px);
}

/* File input styling */
.file-input-wrapper {
position: relative;
overflow: hidden;
display: inline-block;
}

.file-input-wrapper input[type=file] {
position: absolute;
left: -9999px;
}

.file-input-label {
cursor: pointer;
display: inline-block;
}

/* Upload progress */
.upload-progress {
display: none;
margin-top: 1rem;
padding: 1rem;
background: #fff3cd;
border-radius: 8px;
border: 1px solid #ffeaa7;
}

.progress-spinner {
display: inline-block;
width: 20px;
height: 20px;
border: 3px solid #f3f3f3;
border-top: 3px solid #667eea;
border-radius: 50%;
animation: spin 1s linear infinite;
margin-right: 10px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* Chart styles */
.chart-container {
background: white;
border-radius: 12px;
padding: 1.5rem;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
margin-bottom: 2rem;
position: relative;
height: 400px !important;
max-height: 400px !important;
overflow: hidden !important;
transition: transform 0.2s ease;
}

.chart-container:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.chart-container canvas {
max-height: 300px !important;
width: 100% !important;
height: 300px !important;
display: block !important;
box-sizing: border-box !important;
position: relative !important;
}

.chart-wrapper {
position: relative;
height: 300px !important;
max-height: 300px !important;
width: 100%;
overflow: hidden !important;
}

.table-container {
background: white;
border-radius: 12px;
overflow: hidden;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
transition: transform 0.2s ease;
}

.table-container:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.btn-primary {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
border: none;
transition: all 0.2s ease;
}

.btn-primary:hover {
background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
transform: translateY(-1px);
}

.status-badge {
padding: 0.25rem 0.75rem;
border-radius: 20px;
font-size: 0.8rem;
font-weight: 500;
}

.status-excellent { background-color: #d4edda; color: #155724; }
.status-good { background-color: #d1ecf1; color: #0c5460; }
.status-moderate { background-color: #fff3cd; color: #856404; }
.status-poor { background-color: #f8d7da; color: #721c24; }

.loading {
text-align: center;
padding: 2rem;
color: #6c757d;
}

.refresh-indicator {
position: fixed;
top: 20px;
right: 20px;
background: #28a745;
color: white;
padding: 0.5rem 1rem;
border-radius: 20px;
display: none;
z-index: 1000;
animation: slideIn 0.3s ease;
}

@keyframes slideIn {
from { transform: translateX(100%); }
to { transform: translateX(0); }
}

.file-info {
background: #e9ecef;
border-radius: 6px;
padding: 0.75rem;
margin-top: 1rem;
font-size: 0.875rem;
display: none;
border-left: 4px solid #667eea;
}

.help-text {
font-size: 0.875rem;
color: #6c757d;
margin-top: 1rem;
line-height: 1.5;
}

/* Drag and drop styles */
.drag-drop-area {
border: 2px dashed #ccc;
border-radius: 8px;
padding: 2rem;
text-align: center;
transition: all 0.3s ease;
margin: 1rem 0;
background: #fafafa;
}

.drag-drop-area.dragover {
border-color: #667eea;
background-color: #f0f3ff;
transform: scale(1.02);
}

.drag-drop-area:hover {
border-color: #667eea;
background-color: #f8f9ff;
}

.drag-drop-area i {
transition: transform 0.2s ease;
}

.drag-drop-area:hover i {
transform: scale(1.1);
}

/* Analysis section specific styles */
.analysis-section {
background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
border: 2px solid #dee2e6;
border-radius: 8px;
padding: 2rem;
text-align: center;
height: 350px;
display: flex;
flex-direction: column;
justify-content: center;
transition: all 0.3s ease;
}

.analysis-section:hover {
border-color: #28a745;
background: linear-gradient(135deg, #f0fff4 0%, #e6ffed 100%);
}

.analysis-section.ready {
border-color: #28a745;
background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
}

/* Portfolio section styles */
.portfolio-section {
background: white;
border-radius: 12px;
padding: 1.5rem;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
height: 400px;
transition: transform 0.2s ease;
}

.portfolio-section:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

/* Responsive adjustments */
@media (max-width: 768px) {
.upload-section {
min-height: 250px;
padding: 1rem;
}

.metric-value {
font-size: 1.5rem;
}

.chart-container {
height: 300px !important;
}

.chart-container canvas {
height: 200px !important;
max-height: 200px !important;
}

.chart-wrapper {
height: 200px !important;
max-height: 200px !important;
}
}

/* Loading animation */
@keyframes pulse {
0% { opacity: 1; }
50% { opacity: 0.5; }
100% { opacity: 1; }
}

.loading-pulse {
animation: pulse 1.5s ease-in-out infinite;
}

/* Success animations */
@keyframes successPulse {
0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}

.upload-success {
animation: successPulse 1s ease-out;
}

/* Error state */
.upload-error {
border-color: #dc3545 !important;
background: #f8d7da !important;
}

/* Table enhancements */
.table thead th {
background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
border: none;
font-weight: 600;
color: #495057;
}

.table tbody tr {
transition: all 0.2s ease;
}

.table tbody tr:hover {
background-color: #f8f9ff;
transform: scale(1.002);
}

.badge {
font-size: 0.75rem;
padding: 0.375rem 0.75rem;
}

/* Search enhancements */
.search-container {
position: relative;
}

.search-container .form-control {
border-radius: 8px;
border: 2px solid #e9ecef;
transition: all 0.2s ease;
}

.search-container .form-control:focus {
border-color: #667eea;
box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

/* Button enhancements */
.btn {
border-radius: 8px;
font-weight: 500;
transition: all 0.2s ease;
}

.btn:hover {
transform: translateY(-1px);
}

.btn:active {
transform: translateY(0);
}

/* Icon enhancements */
.fas, .far {
transition: transform 0.2s ease;
}

.btn:hover .fas,
.btn:hover .far {
transform: scale(1.1);
}

/* Tooltip styles */
.tooltip {
font-size: 0.875rem;
}

/* Custom scrollbar */
.table-responsive::-webkit-scrollbar {
height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
background: #f1f1f1;
border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb {
background: #667eea;
border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
background: #5a6fd8;
}
</style>
</head>
<body class="bg-light">

<!-- Header -->
<div class="dashboard-header">
<div class="container">
<div class="row align-items-center">
<div class="col-md-8">
<h1 class="display-4 mb-0">
<i class="fas fa-chart-line me-3"></i>Vehicle Import Analyzer
</h1>
<p class="lead mb-0">Upload your vehicle data files (Excel/CSV) for profitable import analysis</p>
</div>
<div class="col-md-4 text-end">
<button class="btn btn-light btn-lg" onclick="exportToExcel()">
<i class="fas fa-download me-2"></i>Export Results
</button>
</div>
</div>
</div>
</div>

<!-- Refresh Indicator -->
<div class="refresh-indicator" id="refreshIndicator">
<i class="fas fa-check-circle me-2"></i>Data updated successfully!
</div>

<div class="container-fluid">

<!-- FILE UPLOAD PANEL -->
<div class="file-upload-panel">
<h3>
<i class="fas fa-cloud-upload-alt"></i>
Data Upload & Analysis
</h3>
<p class="text-muted mb-4">
<i class="fas fa-info-circle me-2"></i>
Upload your vehicle data files in CSV or Excel format to start the analysis. 
Download templates below to see the expected format.
</p>

<div class="row">
<!-- UK Data Upload -->
<div class="col-md-5">
<div class="upload-section" id="ukUploadSection">
<h5>
<i class="fas fa-flag-uk"></i>
UK Market Data
</h5>
<div class="data-status status-empty" id="ukDataStatus">No Data</div>

<div class="drag-drop-area" id="ukDragDrop">
<i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
<h6 class="text-muted mb-3">Drag & drop your UK vehicle data file here</h6>
<p class="text-muted mb-3">or</p>

<div class="file-input-wrapper">
    <input type="file" id="ukFileInput" accept=".csv,.xlsx,.xls" />
    <label for="ukFileInput" class="file-input-label">
        <button type="button" class="upload-btn">
            <i class="fas fa-folder-open me-2"></i>Choose UK Data File
        </button>
    </label>
</div>

<div class="file-info" id="ukFileInfo"></div>
</div>

<div class="upload-progress" id="ukProgress">
<div class="progress-spinner"></div>
<span>
    <i class="fas fa-upload me-2"></i>
    Uploading UK data...
</span>
</div>

<div class="help-text" id="ukHelpText">
<i class="fas fa-lightbulb me-2"></i>
Upload CSV/Excel with columns: make, model, year, price, mileage, fuel_type, transmission, etc.
<br><br>
<button class="template-btn" onclick="downloadTemplate('uk')">
    <i class="fas fa-download me-2"></i>Download UK Template
</button>
</div>
</div>
</div>

<!-- Japan Data Upload -->
<div class="col-md-5">
<div class="upload-section" id="japanUploadSection">
<h5>
<i class="fas fa-torii-gate"></i>
Japan Auction Data
</h5>
<div class="data-status status-empty" id="japanDataStatus">No Data</div>

<div class="drag-drop-area" id="japanDragDrop">
<i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
<h6 class="text-muted mb-3">Drag & drop your Japan auction data file here</h6>
<p class="text-muted mb-3">or</p>

<div class="file-input-wrapper">
    <input type="file" id="japanFileInput" accept=".csv,.xlsx,.xls" />
    <label for="japanFileInput" class="file-input-label">
        <button type="button" class="upload-btn japan-btn">
            <i class="fas fa-folder-open me-2"></i>Choose Japan Data File
        </button>
    </label>
</div>

<div class="file-info" id="japanFileInfo"></div>
</div>

<div class="upload-progress" id="japanProgress">
<div class="progress-spinner"></div>
<span>
    <i class="fas fa-upload me-2"></i>
    Uploading Japan data...
</span>
</div>

<div class="help-text" id="japanHelpText">
<i class="fas fa-lightbulb me-2"></i>
Upload CSV/Excel with columns: make, model, year, final_price_jpy, final_price_gbp, grade, auction_house, etc.
<br><br>
<button class="template-btn" onclick="downloadTemplate('japan')">
    <i class="fas fa-download me-2"></i>Download Japan Template
</button>
</div>
</div>
</div>

<!-- Analysis Section -->
<div class="col-md-2">
<div class="analysis-section" id="analysisSection">
<h5>
<i class="fas fa-chart-line"></i>
Analysis
</h5>
<div class="data-status status-empty" id="analysisStatus">Ready</div>

<div class="d-flex flex-column justify-content-center align-items-center flex-grow-1">
<button class="upload-btn analysis-btn mb-3" id="runAnalysisBtn" onclick="runAnalysis()" disabled>
    <i class="fas fa-play me-2"></i>Run Analysis
</button>

<div class="upload-progress" id="analysisProgress">
    <div class="progress-spinner"></div>
    <span>
        <i class="fas fa-cog fa-spin me-2"></i>
        Analyzing data...
    </span>
</div>
</div>

<div class="help-text text-center" id="analysisHelpText">
<i class="fas fa-exclamation-triangle me-2"></i>
Upload both UK and Japan data first
</div>
</div>
</div>
</div>
</div>

<!-- Key Metrics Row -->
<div class="row mb-4">
<div class="col-md-3">
<div class="metric-card">
<div class="metric-label">
<i class="fas fa-bullseye me-2"></i>Total Opportunities
</div>
<div class="metric-value" id="totalOpportunities">-</div>
<small class="text-muted">Profitable vehicles identified</small>
</div>
</div>
<div class="col-md-3">
<div class="metric-card">
<div class="metric-label">
<i class="fas fa-percentage me-2"></i>Average Profit Margin
</div>
<div class="metric-value" id="avgProfitMargin">-</div>
<small class="text-muted">Expected profit percentage</small>
</div>
</div>
<div class="col-md-3">
<div class="metric-card">
<div class="metric-label">
<i class="fas fa-trophy me-2"></i>Best ROI
</div>
<div class="metric-value" id="bestROI">-</div>
<small class="text-muted">Highest return on investment</small>
</div>
</div>
<div class="col-md-3">
<div class="metric-card">
<div class="metric-label">
<i class="fas fa-pound-sign me-2"></i>Total Profit Potential
</div>
<div class="metric-value" id="totalProfit">-</div>
<small class="text-muted">Combined profit opportunity</small>
</div>
</div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
<div class="col-md-6">
<div class="chart-container">
<h5 class="mb-3">
<i class="fas fa-chart-bar me-2"></i>Profitability by Make
</h5>
<div class="chart-wrapper">
<canvas id="profitabilityChart"></canvas>
</div>
</div>
</div>
<div class="col-md-6">
<div class="chart-container">
<h5 class="mb-3">
<i class="fas fa-chart-scatter me-2"></i>Risk vs Reward Matrix
</h5>
<div class="chart-wrapper">
<canvas id="riskRewardChart"></canvas>
</div>
</div>
</div>
</div>

<!-- Top Opportunities Table -->
<div class="row mb-4">
<div class="col-12">
<div class="table-container">
<div class="p-3 border-bottom">
<div class="row align-items-center">
<div class="col-md-6">
    <h5 class="mb-0">
        <i class="fas fa-star me-2"></i>Top Investment Opportunities
    </h5>
</div>
<div class="col-md-6 text-end">
    <div class="search-container input-group" style="max-width: 300px; margin-left: auto;">
        <input type="text" class="form-control" placeholder="Search vehicles..." id="searchInput">
        <button class="btn btn-outline-secondary" onclick="searchVehicles()">
            <i class="fas fa-search"></i>
        </button>
    </div>
</div>
</div>
</div>

<div class="table-responsive">
<table class="table table-hover mb-0">
<thead class="table-light">
    <tr>
        <th><i class="fas fa-medal me-2"></i>Rank</th>
        <th><i class="fas fa-car me-2"></i>Vehicle</th>
        <th><i class="fas fa-star me-2"></i>Score</th>
        <th><i class="fas fa-percentage me-2"></i>Profit Margin</th>
        <th><i class="fas fa-pound-sign me-2"></i>Expected Profit</th>
        <th><i class="fas fa-chart-line me-2"></i>ROI</th>
        <th><i class="fas fa-shield-alt me-2"></i>Risk Level</th>
        <th><i class="fas fa-tag me-2"></i>Category</th>
        <th><i class="fas fa-cog me-2"></i>Action</th>
    </tr>
</thead>
<tbody id="opportunitiesTableBody">
    <tr>
        <td colspan="9" class="loading">
            <div class="text-muted text-center py